#!/bin/bash -e

# This a helper function to output floating point/decimal division
# It takes two integer arguments and divides them to return the decimal value
# Full credit to user bebbo in:
# https://stackoverflow.com/questions/12722095/how-do-i-use-floating-point-division-in-bash
div() {
  local _d=${3:-2}
  local _n=00000000
  _n=${_n:0:$_d}
  local _r=$(($1$_n/$2))
  _r=${_r:0:-$_d}.${_r: -$_d}
  echo $_r
}

############################################################################
# Function dims takes a file with a numbers matrix as an argument and prints 
# the dimensions of the matrix as the number of rows, followed by a space, 
# then the number of columns.
############################################################################
dims(){
	if [ "$#" -eq 1 ] #If number of arguments is 1
	then
		#Get nummer of lines and display without the iflle's name
		lineCnt=$( wc --lines $1 | cut -d' ' --fields=1 ) 

		#Get the first line and count the number of words
		colCnt=$( head --lines=1 $1 | wc -w )

		#output results
		echo "$lineCnt $colCnt"
	else
		#Number of supplied arguments is not 1
		echo "Invalid number of supplied arguments"
		exit 1
	fi
}

############################################################################
# Function transpose takes a file with a numbers matrix as an argument and  
# reflects the elements of the matrix along the main diagonal. 
# Thus, an MxN matrix becomes an NxM matrix and the values along the main diagonal 
# remain unchanged. Use of array is discouraged.
############################################################################
transpose(){

	if [ "$#" != 1 ] #If number of arguments != 1
	then
		echo "Invalid number of supplied arguments"
		exit 1
	fi
	
	#Get nummer of lines and columns in argument file
	lineCnt=$( wc --lines $1 | cut -d' ' --fields=1 ) 
	colCnt=$( head --lines=1 $1 | wc -w )

	# Create one file for each column
	x=$colCnt
	while [ $x -gt 0 ]; 
	do 
		# Create new temp file or clear previously created files
		touch tr_temp_$x
		printf "" > tr_temp_$x
		x=$(($x-1))
	done

	# Store numbers in temp file in single row
	# Each column in argument file is transposed 
	# into a row in temp file
	while read line
	do
		#track column count
		c_cnt=1
		for i in $line
		do
			# Write the number into a file
			printf "$i\t" >> tr_temp_$c_cnt
			c_cnt=`expr $c_cnt + 1 `
		done
	done < $1 # Read file supplied in argument 1

	# cat out temp files in ascending order
	COUNTER=1
	while [  $COUNTER -le $colCnt ]
	do
		cat tr_temp_$COUNTER
		printf "\n"
		#echo $( cat tr_temp_$COUNTER ) 
		let COUNTER=COUNTER+1 
	done
	
	#remov temp files
	find . -maxdepth 1 -name "tr_temp_*" -exec rm -f {} \;
}

############################################################################
# mean should take an MxN matrix and return an 1xN row vector, where the first 
# element is the mean of column one, the second element is the mean of column two, 
# and so on. Do not use any other languages other than bash shell scripting: 
# this means that, among others, awk, sed, tcl, bc, perl, & the python languages 
# and tools are off-limits for this assignment.
############################################################################
mean () {
	trap "find . -maxdepth 1 -name 'mean_temp.*' -exec rm -f {} \;" INT HUP TERM
	if [ "$#" != 1 ] #If number of arguments != 1
	then
		echo "Invalid number of supplied arguments"
		exit 1
	fi
	
	#Get nummer of lines and columns in argument file
	lineCnt=$( wc --lines $1 | cut -d' ' --fields=1 ) 
	colCnt=$( head --lines=1 $1 | wc -w )
	pid=$$

	# Create one file for each column
	x=$colCnt
	while [ $x -gt 0 ]; 
	do 
		# Create new temp file or clear previously created files
		touch mean_temp.$x
		printf "" > mean_temp.$x
		x=$(($x-1))
	done

	# Store numbers in temp file in single row
	# Each column in argument file is transposed 
	# into a row in temp file
	while read line
	do
		#track column count
		c_cnt=1
		for i in $line
		do
			# Write the number into a file
			printf "$i " >> mean_temp.$c_cnt
			c_cnt=$(expr $c_cnt + 1 )
		done
	done < $1 # Read file supplied in argument 1
	
	# Calculate the mean and store it in a temp file
	cnt=1
	touch mean_temp.o # Create temp file
	while [ $cnt -le $colCnt ]
	do
		printf "\n" >> mean_temp.$cnt
		while read line
		do
			# Sum the numbers
			sum=0
			for i in $line
			do
				sum=$( expr $sum + $i )
			done
		done < mean_temp.$cnt
		# Calculate mean and output to temp file
		printf "$( div $sum $lineCnt ) " >> mean_temp.o
		cnt=$(expr $cnt + 1 )
	done

	#Output results and remove temp files
	cat mean_temp.o	
	find . -maxdepth 1 -name 'mean_temp*' -exec rm -f {} \;
}

###################################################################################
# add should take two MxN matrices and add them together element-wise to produce an MxN matrix. 
# add should return an error if the matrices do not have the same dimensions.
# Do not use any other languages other than bash shell scripting: 
# this means that, among others, awk, sed, tcl, bc, perl, & the python languages 
# and tools are off-limits for this assignment.
####################################################################################
add(){
	if [ "$#" != 2 ] #If number of arguments is 1
	then
		#Number of supplied arguments is not 2
		echo "Invalid number of supplied arguments"
		exit 1
	fi

	find . -maxdepth 1 -name 'add_temp.*' -exec rm -f {} \;

	#Get nummer of lines and display without the iflle's name
	lineCnt1=$( wc --lines $1 | cut -d' ' --fields=1 )
	lineCnt2=$( wc --lines $2 | cut -d' ' --fields=1 )

	#Get the first line and count the number of words
	colCnt1=$( head --lines=1 $1 | wc -w )
	colCnt2=$( head --lines=1 $2 | wc -w )
	coldbl=$(($colCnt1 * 2))

	if [ $lineCnt1 -ne $lineCnt2 ] || [ $colCnt1 -ne $colCnt2 ]
	then
		# Supplied matrices are not equal
		echo "Supplied matrices are not equal"
		exit 1
	fi

	# Store numbers in temp file in single row
	# Each column in argument file is transposed
	# into a row in temp file

	#track file count
	f_cnt=1
	while read line
	do
		for i in $line
		do
			# Write the number into a file
			printf "$i " >> add_temp.$f_cnt
			f_cnt=$(expr $f_cnt + 1 )
		done
	done < $1 # Read file supplied in argument 1

	while read line
	do
		for i in $line
		do
			# Write the number into a file
			printf "$i " >> add_temp.$f_cnt
			f_cnt=$(expr $f_cnt + 1 )
		done
	done < $2 # Read file supplied in argument 2

	# Calculate the sums and store in a temp file
	# Create temp file for storing calculated matrix
	cnt=1
	matrix_cnt=$(( $f_cnt / 2 ))
	touch add_temp.o
	printf "" > add_temp.o
	while [ $cnt -le $matrix_cnt ]
	do
		#printf "last!\n"
		cnt2=$( expr $cnt + $matrix_cnt )

		# Sum the numbers. Take number from current file
		# and add it with the number from (current file + numer of entries in matrix)
		sum=0
		num1=$( head -c1 add_temp.$cnt )
		sum=$( expr $sum + $num1 )
		
		num2=$( head -c1 add_temp.$cnt2 )
		sum=$( expr $sum + $num2 )
		
		# Form summed matrix
		if (( $cnt % $colCnt1 != 0 ))
		then
			# delimitate with tab
			printf "$sum\t" >> add_temp.o	
		else
			# delimitate with new line
			printf "$sum\n" >> add_temp.o
		fi
		cnt=$(expr $cnt + 1 )	
	done

	# Output results and remove temp files
	cat add_temp.o
	find . -maxdepth 1 -name 'add_temp*' -exec rm -f {} \;
}


$1 "${@:2}"
#add m1 m1
echo -e "\n$1 exit with $?"


